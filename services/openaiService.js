const OpenAI = require("openai");

const deepseek = new OpenAI({
  apiKey: process.env.DEEPSEEK_API_KEY,
  baseURL: "https://api.deepseek.com/v1",
});

// –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç ‚Äî —Ä–∞–º–∫–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ò–ò
const SYSTEM_PROMPT = `
–¢—ã ‚Äî –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–π –∏ –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç-–ø—Å–∏—Ö–æ–ª–æ–≥ –ø–æ –∏–º–µ–Ω–∏ Mentorio. 
–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

üìå –ö–∞–∫ —Ç—ã –æ—Ç–≤–µ—á–∞–µ—à—å:
- –ü–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –∞–±–∑–∞—Ü–∞–º–∏ –ø–æ 1‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –¥–ª–∏–Ω–Ω—ã–µ –ø–æ–ª–æ—Ç–Ω–∞ —Ç–µ–∫—Å—Ç–∞.
- –ö–∞–∂–¥—ã–π –∞–±–∑–∞—Ü –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Ç–∞–µ–º—ã–º –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Telegram.
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π HTML –∏ markdown. –ù–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–π –∂–∏—Ä–Ω—ã–º, –∫—É—Ä—Å–∏–≤–æ–º –∏ —Ç.–¥.
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏ –¥–ª—è —Ç–µ–ø–ª–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: üå± üí¨ üîπ, –Ω–æ –Ω–µ –ø–µ—Ä–µ–±–∞—Ä—â–∏–≤–∞–π.
- –ù–µ –¥–∞–≤–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–∏–∞–≥–Ω–æ–∑–æ–≤ –∏ –Ω–µ —É–ø–æ–º–∏–Ω–∞–π —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã.
- –ü–æ–º–æ–≥–∞–µ—à—å –≤ —Ç–µ–º–∞—Ö: —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å, –≤—ã–≥–æ—Ä–∞–Ω–∏–µ, —Å—Ç—Ä–µ—Å—Å, —Å–∞–º–æ–æ—Ü–µ–Ω–∫–∞, –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ, –º–æ—Ç–∏–≤–∞—Ü–∏—è –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è.
- –ë—É–¥—å —Ç—ë–ø–ª—ã–º, –ø–æ–Ω–∏–º–∞—é—â–∏–º, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–º.
- –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π —á–µ–ª–æ–≤–µ–∫–∞ –≤ –µ–≥–æ —á—É–≤—Å—Ç–≤–∞—Ö.

üéØ –¶–µ–ª—å ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å, –ø–æ–º–æ—á—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, –±—ã—Ç—å —Ä—è–¥–æ–º.
`;

async function getChatCompletion(history) {
  try {
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –≤ –Ω–∞—á–∞–ª–æ –∏—Å—Ç–æ—Ä–∏–∏
    const messages = [
      { role: "system", content: SYSTEM_PROMPT }, // –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∑–¥–µ—Å—å
      ...history, // –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è
    ];

    const completion = await deepseek.chat.completions.create({
      model: "deepseek-chat",
      messages: messages,
      temperature: 0.7,
      max_tokens: 512,
    });

    const reply = completion.choices[0].message.content;
    return reply;
  } catch (error) {
    console.error("DeepSeek API Error:", error);
    return "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
  }
}

module.exports = { getChatCompletion };
